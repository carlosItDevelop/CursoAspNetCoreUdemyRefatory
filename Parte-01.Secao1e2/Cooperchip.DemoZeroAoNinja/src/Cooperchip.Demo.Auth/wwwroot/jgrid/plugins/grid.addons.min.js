!function(y){y.jgrid.extend({searchGrid:function(x){return x=y.extend({recreateFilter:!1,drag:!0,sField:"searchField",sValue:"searchString",sOper:"searchOper",sFilter:"filters",loadDefaults:!0,beforeShowSearch:null,afterShowSearch:null,onInitializeSearch:null,closeAfterSearch:!1,closeAfterReset:!1,closeOnEscape:!1,multipleSearch:!1,cloneSearchRowOnAdd:!0,sopt:null,stringResult:void 0,onClose:null,useDataProxy:!1,overlay:!0},y.jgrid.search,x||{}),this.each(function(){var a=this;if(a.grid){var s="fbox_"+a.p.id,e=!0;if(y.fn.searchFilter)if(!0===x.recreateFilter&&y("#"+s).remove(),null!=y("#"+s).html())!1!==(e=!(!y.isFunction(x.beforeShowSearch)||void 0!==(e=x.beforeShowSearch(y("#"+s))))||e)&&(v(),y.isFunction(x.afterShowSearch)&&x.afterShowSearch(y("#"+s)));else{var o,h,p,c=[],u=y("#"+a.p.id).jqGrid("getGridParam","colNames"),t=y("#"+a.p.id).jqGrid("getGridParam","colModel"),f=["eq","ne","lt","le","gt","ge","bw","bn","in","ni","ew","en","cn","nc"],r=[];if(null!==x.sopt)for(o=p=0;o<x.sopt.length;o++)-1!=(h=y.inArray(x.sopt[o],f))&&(r[p]={op:x.sopt[o],text:x.odata[h].text},p++);else for(o=0;o<f.length;o++)r[o]={op:f[o],text:x.odata[o].text};if(y.each(t,function(e,t){var r,i=void 0===t.search||t.search,a=!0===t.hidden,s=y.extend({},{text:u[e],itemval:t.index||t.name},this.searchoptions),e=!0===s.searchhidden;if(void 0!==s.sopt&&(p=0,s.ops=[],0<s.sopt.length))for(o=0;o<s.sopt.length;o++)-1!=(h=y.inArray(s.sopt[o],f))&&(s.ops[p]={op:s.sopt[o],text:x.odata[h].text},p++);if((void 0===this.stype&&(this.stype="text"),"select"==this.stype)&&(void 0===s.dataUrl&&(s.value?r=s.value:this.editoptions&&(r=this.editoptions.value),r)))if(s.dataValues=[],"string"==typeof r){var l,n=r.split(";");for(o=0;o<n.length;o++)l=n[o].split(":"),s.dataValues[o]={value:l[0],text:l[1]}}else if("object"==typeof r)for(var d in o=0,r)r.hasOwnProperty(d)&&(s.dataValues[o]={value:d,text:r[d]},o++);(e&&i||i&&!a)&&c.push(s)}),0<c.length){if(y("<div id='"+s+"' role='dialog' tabindex='-1'></div>").insertBefore("#gview_"+a.p.id),void 0===x.stringResult&&(x.stringResult=x.multipleSearch),a.SearchFilter=y("#"+s).searchFilter(c,{groupOps:x.groupOps,operators:r,onClose:g,resetText:x.Reset,searchText:x.Find,windowTitle:x.caption,rulesText:x.rulesText,matchText:x.matchText,onSearch:function(e){var t=void 0!==e,r=y("#"+a.p.id),i={};!1===x.multipleSearch?(i[x.sField]=e.rules[0].field,i[x.sValue]=e.rules[0].data,i[x.sOper]=e.rules[0].op,i.hasOwnProperty(x.sFilter)&&delete i[x.sFilter]):(i[x.sFilter]=e,y.each([x.sField,x.sValue,x.sOper],function(e,t){i.hasOwnProperty(t)&&delete i[t]})),r[0].p.search=t,y.extend(r[0].p.postData,i),r.trigger("reloadGrid",[{page:1}]),x.closeAfterSearch&&g(y("#"+s))},onReset:function(e){var e=!e||!e.hasOwnProperty("reload")||e.reload,t=y("#"+a.p.id),r={};(t[0].p.search=!1)===x.multipleSearch?r[x.sField]=r[x.sValue]=r[x.sOper]="":r[x.sFilter]="",y.extend(t[0].p.postData,r),e&&t.trigger("reloadGrid",[{page:1}]),x.closeAfterReset&&g(y("#"+s))},stringResult:x.stringResult,ajaxSelectOptions:y.extend({},y.jgrid.ajaxOptions,a.p.ajaxSelectOptions||{}),clone:x.cloneSearchRowOnAdd}),y(".ui-widget-overlay","#"+s).remove(),"rtl"==a.p.direction&&y(".ui-closer","#"+s).css("float","left"),!0===x.drag)if(y("#"+s+" table thead tr:first td:first").css("cursor","move"),jQuery.fn.jqDrag)y("#"+s).jqDrag(y("#"+s+" table thead tr:first td:first"));else try{y("#"+s).draggable({handle:y("#"+s+" table thead tr:first td:first")})}catch(e){}if(!1===x.multipleSearch&&(y(".ui-del, .ui-add, .ui-del, .ui-add-last, .matchText, .rulesText","#"+s).hide(),y("select[name='groupOp']","#"+s).hide()),!0===x.multipleSearch&&!0===x.loadDefaults){var i=a,t=x,l=i.p.postData[t.sFilter];if((l="string"==typeof l?y.jgrid.parse(l):l)&&(l.groupOp&&i.SearchFilter.setGroupOp(l.groupOp),l.rules))for(var n,d=0,m=l.rules.length;d<m;d++)void 0!==(n=l.rules[d]).field&&void 0!==n.op&&void 0!==n.data&&i.SearchFilter.setFilter({sfref:i.SearchFilter.$.find(".sf:last"),filter:y.extend({},n)})&&i.SearchFilter.add()}y.isFunction(x.onInitializeSearch)&&x.onInitializeSearch(y("#"+s)),!1!==(e=y.isFunction(x.beforeShowSearch)&&void 0===(e=x.beforeShowSearch(y("#"+s)))?!0:e)&&(v(),y.isFunction(x.afterShowSearch)&&x.afterShowSearch(y("#"+s)),!0===x.closeOnEscape&&y("#"+s).keydown(function(e){27==e.which&&g(y("#"+s)),13==e.which&&y(".ui-search",this).click()}))}}}function g(e){if(x.onClose){var t=x.onClose(e);if("boolean"==typeof t&&!t)return}e.hide(),!0===x.overlay&&y(".jqgrid-overlay:first","#gbox_"+a.p.id).hide()}function v(){var e,t=y(".ui-searchFilter").length;1<t&&(e=y("#"+s).css("zIndex"),y("#"+s).css({zIndex:parseInt(e,10)+t})),y("#"+s).show(),!0===x.overlay&&y(".jqgrid-overlay:first","#gbox_"+a.p.id).show();try{y(":input:visible","#"+s)[0].focus()}catch(e){}}})},updateGridRows:function(e,n,d){var o,h,p=!1;return this.each(function(){var r,i,a,s,l=this;if(!l.grid)return!1;n=n||"id",e&&0<e.length&&y(e).each(function(e){if(a=this,i=l.rows.namedItem(a[n])){if(s=a[n],!0===d&&!0===l.p.jsonReader.repeatitems){l.p.jsonReader.cell&&(a=a[l.p.jsonReader.cell]);for(var t=0;t<a.length;t++)r=l.formatter(s,a[t],t,a,"edit"),h=l.p.colModel[t].title?{title:y.jgrid.stripHtml(r)}:{},(!0===l.p.treeGrid&&o==l.p.ExpandColumn?y("td:eq("+t+") > span:first",i):y("td:eq("+t+")",i)).html(r).attr(h);return p=!0}y(l.p.colModel).each(function(e){o=!0===d&&this.jsonmap||this.name,void 0!==a[o]&&(r=l.formatter(s,a[o],e,a,"edit"),h=this.title?{title:y.jgrid.stripHtml(r)}:{},(!0===l.p.treeGrid&&o==l.p.ExpandColumn?y("td:eq("+e+") > span:first",i):y("td:eq("+e+")",i)).html(r).attr(h),p=!0)})}})}),p},filterGrid:function(l,n){return n=y.extend({gridModel:!1,gridNames:!1,gridToolbar:!1,filterModel:[],formtype:"horizontal",autosearch:!0,formclass:"filterform",tableclass:"filtertable",buttonclass:"filterbutton",searchButton:"Search",clearButton:"Clear",enableSearch:!1,enableClear:!1,beforeSearch:null,afterSearch:null,beforeClear:null,afterClear:null,url:"",marksearched:!0},n||{}),this.each(function(){var i,a,s,p,e,t,c,r,u,f,m,g,v=this;this.p=n,0===this.p.filterModel.length&&!1===this.p.gridModel?alert("No filter is set"):l?(this.p.gridid=-1!=l.indexOf("#")?l:"#"+l,(i=y(this.p.gridid).jqGrid("getGridParam","colModel"))?(!0===this.p.gridModel?(a=y(this.p.gridid)[0],y.each(i,function(e,t){var r=[];this.search=!1!==this.search,s=!(!this.editrules||!0!==this.editrules.searchhidden)||!0!==this.hidden,!0===this.search&&!0===s&&(!0===v.p.gridNames?r.label=a.p.colNames[e]:r.label="",r.name=this.name,r.index=this.index||this.name,r.stype=this.edittype||"text","select"!=r.stype&&(r.stype="text"),r.defval=this.defval||"",r.surl=this.surl||"",r.sopt=this.editoptions||{},r.width=this.width,v.p.filterModel.push(r))})):y.each(v.p.filterModel,function(e,t){for(var r=0;r<i.length;r++)if(this.name==i[r].name){this.index=i[r].index||this.name;break}this.index||(this.index=this.name)}),p=function(){var r,i,e,a={},s=0,l=y(v.p.gridid)[0],t=(l.p.searchdata={},y.isFunction(v.p.beforeSearch)&&v.p.beforeSearch(),y.each(v.p.filterModel,function(e,t){if(i=this.index,"select"===this.stype)if(r=y("select[name="+i+"]",v).val())a[i]=r,v.p.marksearched&&y("#jqgh_"+this.name,l.grid.hDiv).addClass("dirty-cell"),s++;else{v.p.marksearched&&y("#jqgh_"+this.name,l.grid.hDiv).removeClass("dirty-cell");try{delete l.p.postData[this.index]}catch(e){}}else if(r=y("input[name="+i+"]",v).val())a[i]=r,v.p.marksearched&&y("#jqgh_"+this.name,l.grid.hDiv).addClass("dirty-cell"),s++;else{v.p.marksearched&&y("#jqgh_"+this.name,l.grid.hDiv).removeClass("dirty-cell");try{delete l.p.postData[this.index]}catch(e){}}}),0<s);y.extend(l.p.postData,a),v.p.url&&(e=y(l).jqGrid("getGridParam","url"),y(l).jqGrid("setGridParam",{url:v.p.url})),y(l).jqGrid("setGridParam",{search:t}).trigger("reloadGrid",[{page:1}]),e&&y(l).jqGrid("setGridParam",{url:e}),y.isFunction(v.p.afterSearch)&&v.p.afterSearch()},e=function(){var i,a,e,s={},l=0,n=y(v.p.gridid)[0],t=(y.isFunction(v.p.beforeClear)&&v.p.beforeClear(),y.each(v.p.filterModel,function(e,t){switch(a=this.index,i=this.defval||"",this.stype||(this.stype="text"),this.stype){case"select":var r;if(y("select[name="+a+"] option",v).each(function(e){if(0===e&&(this.selected=!0),y(this).text()==i)return this.selected=!0,r=y(this).val(),!1}),r)s[a]=r,v.p.marksearched&&y("#jqgh_"+this.name,n.grid.hDiv).addClass("dirty-cell"),l++;else{v.p.marksearched&&y("#jqgh_"+this.name,n.grid.hDiv).removeClass("dirty-cell");try{delete n.p.postData[this.index]}catch(e){}}break;case"text":if(y("input[name="+a+"]",v).val(i),i)s[a]=i,v.p.marksearched&&y("#jqgh_"+this.name,n.grid.hDiv).addClass("dirty-cell"),l++;else{v.p.marksearched&&y("#jqgh_"+this.name,n.grid.hDiv).removeClass("dirty-cell");try{delete n.p.postData[this.index]}catch(e){}}}}),0<l);y.extend(n.p.postData,s),v.p.url&&(e=y(n).jqGrid("getGridParam","url"),y(n).jqGrid("setGridParam",{url:v.p.url})),y(n).jqGrid("setGridParam",{search:t}).trigger("reloadGrid",[{page:1}]),e&&y(n).jqGrid("setGridParam",{url:e}),y.isFunction(v.p.afterClear)&&v.p.afterClear()},t=y("<form name='SearchForm' style=display:inline;' class='"+this.p.formclass+"'></form>"),g=y("<table class='"+this.p.tableclass+"' cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),y(t).append(g),m=document.createElement("tr"),"horizontal"==v.p.formtype&&y(g).append(m),y.each(v.p.filterModel,function(e,t){u=document.createElement("td"),y(u).append("<label for='"+this.name+"'>"+this.label+"</label>"),f=document.createElement("td");var r=this;switch(this.stype||(this.stype="text"),this.stype){case"select":if(this.surl)y(f).load(this.surl,function(){r.defval&&y("select",this).val(r.defval),y("select",this).attr({name:r.index||r.name,id:"sg_"+r.name}),r.sopt&&y("select",this).attr(r.sopt),!0===v.p.gridToolbar&&r.width&&y("select",this).width(r.width),!0===v.p.autosearch&&y("select",this).change(function(e){return p(),!1})});else if(r.sopt.value){var i,a,s=r.sopt.value,l=document.createElement("select");if(y(l).attr({name:r.index||r.name,id:"sg_"+r.name}).attr(r.sopt),"string"==typeof s)for(var n=s.split(";"),d=0;d<n.length;d++)i=n[d].split(":"),(a=document.createElement("option")).value=i[0],a.innerHTML=i[1],i[1]==r.defval&&(a.selected="selected"),l.appendChild(a);else if("object"==typeof s)for(var o in s)s.hasOwnProperty(o)&&((a=document.createElement("option")).value=o,a.innerHTML=s[o],s[o]==r.defval&&(a.selected="selected"),l.appendChild(a));!0===v.p.gridToolbar&&r.width&&y(l).width(r.width),y(f).append(l),!0===v.p.autosearch&&y(l).change(function(e){return p(),!1})}break;case"text":var h=this.defval||"";y(f).append("<input type='text' name='"+(this.index||this.name)+"' id='sg_"+this.name+"' value='"+h+"'/>"),r.sopt&&y("input",f).attr(r.sopt),!0===v.p.gridToolbar&&r.width&&(y.browser.msie?y("input",f).width(r.width-4):y("input",f).width(r.width-2)),!0===v.p.autosearch&&y("input",f).keypress(function(e){return 13==(e.charCode||e.keyCode||0)?(p(),!1):this})}"horizontal"==v.p.formtype?((!0===v.p.gridToolbar&&!1===v.p.gridNames?y(m):y(m).append(u)).append(f),y(m).append(f)):(c=document.createElement("tr"),y(c).append(u).append(f),y(g).append(c))}),f=document.createElement("td"),!0===v.p.enableSearch&&(r="<input type='button' id='sButton' class='"+v.p.buttonclass+"' value='"+v.p.searchButton+"'/>",y(f).append(r),y("input#sButton",f).click(function(){return p(),!1})),!0===v.p.enableClear&&(r="<input type='button' id='cButton' class='"+v.p.buttonclass+"' value='"+v.p.clearButton+"'/>",y(f).append(r),y("input#cButton",f).click(function(){return e(),!1})),!0!==v.p.enableClear&&!0!==v.p.enableSearch||("horizontal"==v.p.formtype?y(m).append(f):(c=document.createElement("tr"),y(c).append("<td>&#160;</td>").append(f),y(g).append(c))),y(this).append(t),this.triggerSearch=p,this.clearSearch=e):alert("Could not get grid colModel")):alert("No target grid is set!")})}})}(jQuery);