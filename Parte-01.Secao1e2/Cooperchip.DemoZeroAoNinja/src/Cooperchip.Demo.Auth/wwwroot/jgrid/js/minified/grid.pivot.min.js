!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(q){"use strict";q.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},q.jgrid.extend({pivotSetup:function(_,e){var F=[],H=[],A=[],k=[],G=[],M={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},z=[],V=q.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var d,f,p,e,r,c=this,o=_.length,t=0;function i(e,r){var o,t=0,i=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){i=!1;break}if(++t>=this.length)break}return i&&(j=r),i}function n(e,r,o,t){var i,n,a,l,s=r.length,g="",u=[],m=1;for(Array.isArray(o)?(a=o.length,u=o):(a=1,u[0]=o),G=[],n=(k=[]).root=0;n<a;n++){for(var d,f=[],p=0;p<s;p++){if(l="string"==typeof r[p].aggregator?r[p].aggregator:"cust",null==o)d=i=q.jgrid.trim(r[p].member)+"_"+l,u[0]=r[p].label||l+" "+q.jgrid.trim(r[p].member);else{d=o[n].replace(/\s+/g,"");try{i=1===s?g+d:g+d+"_"+l+"_"+String(p)}catch(e){}u[n]=o[n]}i=isNaN(parseInt(i,10))?i:i+" ","avg"===r[p].aggregator&&(l=-1===j?H.length+"_"+i:j+"_"+i,h[l]?h[l]++:h[l]=1,m=h[l]),t[i]=f[i]=function(e,r,o,t,i){var n;if(q.jgrid.isFunction(e))n=e.call(c,r,o,t);else switch(e){case"sum":n=q.jgrid.floatNum(r)+q.jgrid.floatNum(t[o]);break;case"count":""!==r&&null!=r||(r=0),n=t.hasOwnProperty(o)?r+1:0;break;case"min":n=""===r||null==r?q.jgrid.floatNum(t[o]):Math.min(q.jgrid.floatNum(r),q.jgrid.floatNum(t[o]));break;case"max":n=""===r||null==r?q.jgrid.floatNum(t[o]):Math.max(q.jgrid.floatNum(r),q.jgrid.floatNum(t[o]));break;case"avg":n=(q.jgrid.floatNum(r)*(i-1)+q.jgrid.floatNum(t[o]))/i}return n}(r[p].aggregator,t[i],r[p].member,e,m)}g+=o&&null!=o[n]?o[n].replace(/\s+/g,""):"",k[i]=f,G[i]=u[n]}return t}if(V.rowTotals&&0<V.yDimension.length&&(e=V.yDimension[0].dataName,V.yDimension.splice(0,0,{dataName:e}),V.yDimension[0].converter=function(){return"_r_Totals"}),d=Array.isArray(V.xDimension)?V.xDimension.length:0,f=V.yDimension.length,p=Array.isArray(V.aggregates)?V.aggregates.length:0,0===d||0===p)throw"xDimension or aggregates optiona are not set!";for(v=0;v<d;v++)r={name:V.xDimension[v].dataName,frozen:V.frozenStaticCols},null==V.xDimension[v].isGroupField&&(V.xDimension[v].isGroupField=!0),r=q.extend(!0,r,V.xDimension[v]),F.push(r);for(var a=d-1,l={},h=[];t<o;){for(var s=_[t],g=[],u=[],m={},v=0;g[v]=q.jgrid.trim(s[V.xDimension[v].dataName]),m[V.xDimension[v].dataName]=g[v],++v<d;);var y,x=0,j=-1;if(y=H,y=0<(y=function(e,r){var o,t,i,n=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(i=this.length,o=0;o<i;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){n.push(t);break}return n}.call(y,i,g)).length?y[0]:null){if(0<=j){if(x=0,1<=f){for(x=0;x<f;x++)u[x]=q.jgrid.trim(s[V.yDimension[x].dataName]),V.yDimension[x].converter&&q.jgrid.isFunction(V.yDimension[x].converter)&&(u[x]=V.yDimension[x].converter.call(this,u[x],g,u));y=n(s,V.aggregates,u,y)}else 0===f&&(y=n(s,V.aggregates,null,y));H[j]=y}}else{if(x=0,1<=f){for(x=0;x<f;x++)u[x]=q.jgrid.trim(s[V.yDimension[x].dataName]),V.yDimension[x].converter&&q.jgrid.isFunction(V.yDimension[x].converter)&&(u[x]=V.yDimension[x].converter.call(this,u[x],g,u));m=n(s,V.aggregates,u,m)}else 0===f&&(m=n(s,V.aggregates,null,m));H.push(m)}var b,w=0,D=null,N=null;for(b in k)if(k.hasOwnProperty(b)){if(0===w)D=(l=l.children&&void 0!==l.children?l:{text:b,level:0,children:[],label:b}).children;else{for(N=null,v=0;v<D.length;v++)if(D[v].text===b){N=D[v];break}D=(N||(D.push({children:[],text:b,level:w,fields:k[b],label:G[b]}),D[D.length-1])).children}w++}t++}var O,h=null,S=[],T=F.length,C=T;if(0<f&&(z[f-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,i,n,a;for(i in r)if(r.hasOwnProperty(i)){if("object"!=typeof r[i]){if("level"===i){if(void 0===S[r.level]&&(S[r.level]="",0<r.level)&&-1===r.text.indexOf("_r_Totals")&&(z[r.level-1]={useColSpanStyle:!1,groupHeaders:[]}),S[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){z[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var l=z[r.level-1].groupHeaders.length-1,s=0==l?C:T;if(r.level-1==(V.rowTotals?1:0)&&0<l){for(var g=0,u=0;u<l;u++)g+=z[r.level-1].groupHeaders[u].numberOfColumns;g&&(s=g+d)}F[s]&&(z[r.level-1].groupHeaders[l].startColumnName=F[s].name,z[r.level-1].groupHeaders[l].numberOfColumns=F.length-s),T=F.length}S[r.level]=r.text}if(r.level===f&&"level"===i&&0<f)if(1<p){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&z[f-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);z[f-1].groupHeaders[z[f-1].groupHeaders.length-1].numberOfColumns=m-1}else z.splice(f-1,1)}if(null!=r[i]&&"object"==typeof r[i]&&e(r[i]),"level"===i&&0<r.level&&(r.level===(0===f?r.level:f)||-1!==S[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(n in a={},V.aggregates[t])if(V.aggregates[t].hasOwnProperty(n))switch(n){case"member":case"label":case"aggregator":break;default:a[n]=V.aggregates[t][n]}1<p?(a.name=o,a.label=V.aggregates[t].label||r.label):(a.name=r.text,a.label="_r_Totals"===r.text?V.rowTotalsText:r.label),F.push(a),t++}}}(l),V.colTotals)for(var P=H.length;P--;)for(v=d;v<F.length;v++)O=F[v].name,A[O]?A[O]+=q.jgrid.floatNum(H[P][O]):A[O]=q.jgrid.floatNum(H[P][O]);if(0<a)for(v=0;v<a;v++)F[v].isGroupField&&(M.groupingView.groupField.push(F[v].name),M.groupingView.groupSummary.push(V.groupSummary),M.groupingView.groupSummaryPos.push(V.groupSummaryPos));else M.grouping=!1;M.sortname=F[a].name,M.groupingView.hideFirstGroupCol=!0}),{colModel:F,rows:H,groupOptions:M,groupHeaders:z,summary:A}},jqPivot:function(o,g,u,t){return this.each(function(){var s=this,e=u.regional||"en";function r(e){q.jgrid.isFunction(g.onInitPivot)&&g.onInitPivot.call(s),Array.isArray(e)||(e=[]);var r,o,t,i,n=jQuery(s).jqGrid("pivotSetup",e,g),e=0<q.assocArraySize(n.summary),a=q.jgrid.from.call(s,n.rows);for(g.ignoreCase&&(a=a.ignoreCase()),r=0;r<n.groupOptions.groupingView.groupField.length;r++)o=g.xDimension[r].sortorder||"asc",t=g.xDimension[r].sorttype||"text",a.orderBy(n.groupOptions.groupingView.groupField[r],o,t,"",t);if(i=g.xDimension.length,u.sortname){for(o=u.sortorder||"asc",t="text",r=0;r<i;r++)if(g.xDimension[r].dataName===u.sortname){t=g.xDimension[r].sorttype||"text";break}a.orderBy(u.sortname,o,t,"",t)}else n.groupOptions.sortname&&i&&(o=g.xDimension[i-1].sortorder||"asc",t=g.xDimension[i-1].sorttype||"text",a.orderBy(n.groupOptions.sortname,o,t,"",t));jQuery(s).jqGrid(q.extend(!0,{datastr:q.extend(a.select(),e?{userdata:n.summary}:{}),datatype:"jsonstring",footerrow:e,userDataOnFooter:e,colModel:n.colModel,viewrecords:!0,formatFooterData:!0===g.colTotals,sortname:g.xDimension[0].dataName},n.groupOptions,u||{}));var l=n.groupHeaders;if(l.length)for(r=0;r<l.length;r++)l[r]&&l[r].groupHeaders.length&&jQuery(s).jqGrid("setGroupHeaders",l[r]);g.frozenStaticCols&&jQuery(s).jqGrid("setFrozenColumns"),q.jgrid.isFunction(g.onCompletePivot)&&g.onCompletePivot.call(s),g.loadMsg&&q(".loading_pivot").remove()}void 0===g.loadMsg&&(g.loadMsg=!0),g.loadMsg&&q("<div class='loading_pivot ui-state-default ui-state-active row'>"+q.jgrid.getRegional(s,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(s).show(),"string"==typeof o?q.ajax(q.extend({url:o,dataType:"json",success:function(e){r(q.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});